<!DOCTYPE html>
<html>
<head>
  <title>è¡€åœ§ãƒ»ä½“æ¸© è¨˜éŒ²ãƒ„ãƒ¼ãƒ« (å¤–éƒ¨APIé€£æº)</title>
  <style>
    /* 1. åŸºæœ¬è¨­å®šï¼ˆPC/ã‚¹ãƒãƒ›å…±é€šï¼‰ - (uuu.txt ã®å†…å®¹ã‚’æµç”¨) */
    body { 
        font-family: sans-serif; 
        padding: 20px; 
        max-width: 600px; /* PCã§ã‚‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒåºƒãŒã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
        margin: 0 auto; /* ä¸­å¤®å¯„ã› */
        background-color: #f4f4f4; /* èƒŒæ™¯è‰²ã‚’è¿½åŠ  */
    }
    h1 { 
        font-size: 1.8em; /* è¦‹å‡ºã—ã‚’å¤§ãã */
        color: #333;
    }
    label { 
        display: block; 
        margin-top: 15px; 
        font-weight: bold; 
        font-size: 1.1em; /* ãƒ©ãƒ™ãƒ«ã‚’å°‘ã—å¤§ãã */
    }
    select, input[type="text"], input[type="number"] {
        width: 100%; 
        padding: 12px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã—ã¦ã‚¿ãƒƒãƒã—ã‚„ã™ã */
        margin-top: 8px; 
        box-sizing: border-box; 
        border: 1px solid #ccc; 
        border-radius: 6px; /* è§’ã‚’ä¸¸ã */
        font-size: 1.1em; /* æ–‡å­—ã‚’å¤§ãã */
    }
    
    /* 2. ãƒœã‚¿ãƒ³è¨­å®š */
    button { 
        width: 100%; 
        padding: 15px; /* ãƒœã‚¿ãƒ³ã‚’å¤§ãã */
        margin-top: 25px; 
        box-sizing: border-box; 
        color: white; 
        border: none; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 1.1em; /* æ–‡å­—ã‚’å¤§ãã */
        font-weight: bold;
        transition: background-color 0.3s;
    }
    button:active { opacity: 0.8; }
    button:disabled { background-color: #cccccc !important; cursor: not-allowed; }
    #authButton { background-color: #4CAF50; }
    #recordButton { background-color: #007bff; }
    
    /* 3. è¡€åœ§å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ— (ä»Šå›ã¯ä½“æ¸©ã®ã¿ãªã®ã§çœç•¥) */
    
    /* 4. å‡ºåŠ›ã‚¨ãƒªã‚¢ */
    #output { 
        margin-top: 30px; 
        padding: 15px; 
        border: 1px solid #ddd; 
        white-space: pre-wrap; 
        background-color: #ffffff; /* èƒŒæ™¯ã‚’ç™½ã« */
        border-left: 5px solid #007bff; 
        border-radius: 6px;
        font-size: 1em;
    }
    .status { 
        color: gray; 
        background-color: #f9f9f9; 
        border-left: 5px solid #ccc; 
    }
    .hidden { display: none; }


    /* --- 5. ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª (ã‚¹ãƒãƒ›ç¸¦ç”»é¢ãªã©ç‹­ã„ç”»é¢ã¸ã®å¯¾å¿œ) --- */
    /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆãƒ¡ã‚¿ã‚¿ã‚°ã®è¿½åŠ ãŒé‡è¦ã§ã™ã€‚å¤–éƒ¨ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¯<head>ã«ç›´æ¥è¨˜è¿°ã—ã¾ã™ã€‚ */
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    @media (max-width: 480px) {
        body {
            padding: 15px;
        }
    }
</style>
</head>
<body>
  <h1>è¡€åœ§ãƒ»ä½“æ¸© è¨˜éŒ²ãƒ„ãƒ¼ãƒ«</h1>
  
  <label for="attendeeSelect">åˆ©ç”¨è€… é¸æŠ</label>
  <select id="attendeeSelect" disabled>
    <option value="">-- ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­ --</option>
  </select>
  
  <label for="staffSelect">æ¸¬å®šè€… é¸æŠ</label>
  <select id="staffSelect" disabled>
    <option value="">-- ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­ --</option>
  </select>

  <label for="temperatureInput">ä½“æ¸© (Eåˆ—)</label>
  <input type="number" id="temperatureInput" step="0.1" min="30.0" max="42.0" placeholder="ä¾‹: 36.5">
  
  <button id="authButton" onclick="handleAuth()">HealthPlanetã§èªè¨¼</button>
  <button id="recordButton" onclick="handleRecord()" disabled>é¸æŠã—ãŸåˆ©ç”¨è€…ã®ãƒã‚¤ã‚¿ãƒ«ã‚’è¨˜éŒ²</button>
  
  <div id="output" class="status">åˆæœŸæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
  
  <script>
    // ------------------------------------------
    // ğŸ’¥ å¿…é ˆ: GAS API URL ã«ç½®ãæ›ãˆã¦ãã ã•ã„ ğŸ’¥
    // ------------------------------------------
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx03kHLVR3IFb3ZrBWNFU_0Q8nI_1EDCa0mzyrsUQVKIOoLJEmvi1X9SOIFpqs4gQgi9A/exec'; 

    // DOMè¦ç´ 
    const authButton = document.getElementById('authButton');
    const recordButton = document.getElementById('recordButton');
    const attendeeSelect = document.getElementById('attendeeSelect');
    const staffSelect = document.getElementById('staffSelect');
    const temperatureInput = document.getElementById('temperatureInput');
    const outputDiv = document.getElementById('output');

    const API_TIMEOUT = 15000; // 15ç§’

    // ------------------------------------------
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°: fetchApiWithTimeout
    // ------------------------------------------
    
    /** GAS APIã¸ã®ãƒ•ã‚§ãƒƒãƒå‡¦ç†ã¨ã‚¨ãƒ©ãƒ¼/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ */
    async function fetchApiWithTimeout(url, options, timeoutMsg = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚') {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), API_TIMEOUT);

        try {
            const response = await fetch(url, { ...options, signal: controller.signal });
            clearTimeout(id);
            
            if (!response.ok) {
                // CORSè¨­å®šã‚„GAS APIå´ã®å•é¡Œã§HTTPã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                throw new Error(`HTTPã‚¨ãƒ©ãƒ¼ ${response.status}: GASã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚CORSè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }

            const json = await response.json();
            
            // GAS API (createJsonResponse) ã‹ã‚‰è¿”ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼å¿œç­”å‡¦ç†
            if (json.status === 'error') {
                throw new Error(json.message);
            }
            
            return json;

        } catch (error) {
            clearTimeout(id);
            if (error.name === 'AbortError') {
                throw new Error(timeoutMsg);
            }
            throw error;
        }
    }


    // ------------------------------------------
    // åˆæœŸå‡¦ç†ï¼šåˆ©ç”¨è€…ãƒªã‚¹ãƒˆã¨è·å“¡ãƒªã‚¹ãƒˆã®å–å¾— (GET API)
    // ------------------------------------------
    async function loadInitialData() {
        outputDiv.innerHTML = 'åˆ©ç”¨è€…ãƒªã‚¹ãƒˆã¨è·å“¡ãƒªã‚¹ãƒˆã‚’å–å¾—ä¸­...';
        
        try {
            // åˆ©ç”¨è€…ãƒªã‚¹ãƒˆå–å¾—: GET ?action=get_attendees ã‚’å‘¼ã³å‡ºã™
            const attendeeUrl = `${GAS_API_URL}?action=get_attendees`;
            const attendeeResponse = await fetchApiWithTimeout(
                attendeeUrl, { method: 'GET' }, 'åˆ©ç”¨è€…ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
            populateAttendees(attendeeResponse.data);

            // è·å“¡ãƒªã‚¹ãƒˆå–å¾—: GET ?action=get_staffs ã‚’å‘¼ã³å‡ºã™
            const staffUrl = `${GAS_API_URL}?action=get_staffs`;
            const staffResponse = await fetchApiWithTimeout(
                staffUrl, { method: 'GET' }, 'è·å“¡ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
            populateStaffs(staffResponse.data);

            // ãƒªã‚¹ãƒˆå–å¾—æˆåŠŸå¾Œã€èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            checkAuthorizationStatus();

        } catch (error) {
            showError(error);
        }
    }

    // ------------------------------------------
    // èªè¨¼å‡¦ç† (GET API)
    // ------------------------------------------
    async function handleAuth() {
        outputDiv.innerHTML = 'èªè¨¼URLã‚’ç”Ÿæˆä¸­...';
        
        try {
            // èªè¨¼URLå–å¾—: GET ?action=get_auth_url ã‚’å‘¼ã³å‡ºã™
            const authUrl = `${GAS_API_URL}?action=get_auth_url`;
            const response = await fetchApiWithTimeout(
                authUrl, { method: 'GET' }, 'èªè¨¼URLã®ç”ŸæˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
            
            openAuthWindow(response.data.url);

        } catch (error) {
            showError(error);
        }
    }

    // ------------------------------------------
    // è¨˜éŒ²å‡¦ç† (POST API)
    // ------------------------------------------
    async function handleRecord() {
        const userId = attendeeSelect.value;
        const measurerId = staffSelect.value;
        const temp = temperatureInput.value;

        if (!userId || !measurerId || !temp || isNaN(temp) || Number(temp) < 30 || Number(temp) > 42) {
             alert('åˆ©ç”¨è€…ã€æ¸¬å®šè€…ã‚’é¸æŠã—ã€æœ‰åŠ¹ãªä½“æ¸© (30.0â„ƒï½42.0â„ƒ) ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
             return;
        }

        outputDiv.innerHTML = `åˆ©ç”¨è€… ${userId} ã®ãƒã‚¤ã‚¿ãƒ«ã‚’è¨˜éŒ²ä¸­... (POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ)`;
        recordButton.disabled = true;
        
        try {
            const postData = {
                userId: userId,
                measurerId: measurerId,
                temperature: Number(temp)
            };

            // POST /exec ã‚’å‘¼ã³å‡ºã—ã€JSONã‚’é€ä¿¡
            const response = await fetchApiWithTimeout(
                GAS_API_URL, 
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                },
                'è¨˜éŒ²å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'
            );
            
            showResult(response.message);

        } catch (error) {
            showError(error);
            recordButton.disabled = false;
        }
    }

    // ------------------------------------------
    // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ (GET API)
    // ------------------------------------------
    async function checkAuthorizationStatus() {
        outputDiv.innerHTML = 'HealthPlanetèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...';

        try {
            // ã‚µãƒ¼ãƒãƒ¼å´ã§èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å°‚ç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚’æƒ³å®š
            // (GASå´: doGet?action=check_auth_status)
            const authCheckUrl = `${GAS_API_URL}?action=check_auth_status`;
            const response = await fetchApiWithTimeout(
                authCheckUrl, { method: 'GET' }, 'èªè¨¼çŠ¶æ…‹ã®ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
            
            // ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åŸºã«å‡¦ç†
            if (response.data && response.data.authorized) {
                recordButton.disabled = false;
                authButton.style.display = 'none'; 
                outputDiv.innerHTML = 'èªè¨¼æ¸ˆã¿ã§ã™ã€‚åˆ©ç”¨è€…ã€æ¸¬å®šè€…ã‚’é¸æŠã—ã€ä½“æ¸©ã‚’å…¥åŠ›ã—ã¦è¨˜éŒ²ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            } else {
                recordButton.disabled = true;
                authButton.style.display = 'block'; 
                outputDiv.innerHTML = 'ã¾ã HealthPlanetã®èªè¨¼ãŒã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€ŒHealthPlanetã§èªè¨¼ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            }
            
        } catch(error) {
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ã€æœªèªè¨¼ã¨ã—ã¦æ‰±ã†ã‹ã€ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
            recordButton.disabled = true;
            authButton.style.display = 'block'; 
            outputDiv.innerHTML = `èªè¨¼çŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}ã€‚ã€ŒHealthPlanetã§èªè¨¼ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`;
        }
    }


    // ------------------------------------------
    // UIæ›´æ–°ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨)
    // ------------------------------------------
    
    function populateAttendees(attendees) {
      if (attendees.length === 0) {
        attendeeSelect.innerHTML = '<option value="">-- æœ¬æ—¥ã®ã”åˆ©ç”¨è€…ã¯ã„ã¾ã›ã‚“ --</option>';
      } else {
        attendeeSelect.innerHTML = '<option value="">-- ã”åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
        attendees.forEach(function(attendant) {
          const option = document.createElement('option');
          option.value = attendant.id;
          option.textContent = `${attendant.name} (${attendant.id})`;
          attendeeSelect.appendChild(option);
        });
      }
      attendeeSelect.disabled = false;
    }
    
    function populateStaffs(staffs) {
      if (staffs.length === 0) {
        staffSelect.innerHTML = '<option value="">-- æœ¬æ—¥ã®å‡ºå‹¤è·å“¡ã¯ã„ã¾ã›ã‚“ --</option>';
      } else {
        staffSelect.innerHTML = '<option value="">-- æ¸¬å®šè€…ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
        staffs.forEach(function(staff) {
          const option = document.createElement('option');
          option.value = staff.id;
          option.textContent = `${staff.name} (${staff.id})`;
          staffSelect.appendChild(option);
        });
      }
      staffSelect.disabled = false;
    }

    function openAuthWindow(url) {
      outputDiv.innerHTML = 'æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§èªè¨¼ã‚’å®Œäº†ã—ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚';
      const authWindow = window.open(url, 'HealthPlanetAuth', 'width=600,height=800');
      const checkAuth = setInterval(() => {
        if (authWindow.closed) {
          clearInterval(checkAuth);
          // èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ãŸã‚‰ã€èªè¨¼çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
          checkAuthorizationStatus(); 
        }
      }, 500);
    }
    
    function showResult(result) {
      outputDiv.classList.remove('status');
      outputDiv.innerHTML = result;
      recordButton.disabled = false;
      // æˆåŠŸã—ãŸã‚‰å…¥åŠ›é …ç›®ã‚’ãƒªã‚»ãƒƒãƒˆ
      attendeeSelect.value = '';
      staffSelect.value = '';
      temperatureInput.value = '';
    }
    
    function showError(error) {
      outputDiv.classList.add('status');
      outputDiv.innerHTML = `ğŸ”´ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:\n${error.message}`;
      recordButton.disabled = false;
    }
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®é–‹å§‹å‡¦ç†
    loadInitialData();
  </script>
</body>
</html>