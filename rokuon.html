<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>録音報告システム（改善版）</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; }
        #app { max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { font-size: 1.1rem; color: #333; margin-top: 0; margin-bottom: 12px; }
        .input-field { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1.1rem; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .btn-option { padding: 12px; border: 2px solid #ddd; border-radius: 10px; background: #fff; font-weight: bold; }
        .btn-option.active { background: #4caf50; color: white; border-color: #4caf50; }
        .btn-open-modal { width: 100%; padding: 15px; background: #e53935; color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; position: relative; }
        
        /* 録音ボタンのデザイン変更 */
        .btn-record { width: 100px; height: 100px; border-radius: 50%; border: none; background: #e53935; color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); outline: none; margin-bottom: 20px; cursor: pointer; transition: transform 0.2s; }
        .btn-record.recording { background: #555; animation: pulse 1.5s infinite; transform: scale(1.1); }
        
        /* ビジュアライザー用キャンバス */
        #visualizer { width: 100%; height: 60px; background: #f0f0f0; border-radius: 5px; margin-bottom: 20px; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(229, 57, 53, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); } }
        .loading-spinner { text-align: center; color: #2196f3; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div id="app">
    <div class="card">
        <h2>1. 店舗・部署を選択</h2>
        <div class="grid-2">
            <select class="input-field" v-model="selectedStore" @change="saveStore">
                <option value="" disabled>店舗</option>
                <option v-for="(val, name) in stores" :key="val" :value="name">{{ name }}</option>
            </select>
            <select class="input-field" v-model="selectedCategory" @change="saveCategory">
                <option value="" disabled>部門</option>
                <option v-for="(val, name) in categories" :key="val" :value="name">{{ name }}</option>
            </select>
        </div>
    </div>

    <div class="card">
        <h2>2. 職員番号</h2>
        <input type="tel" class="input-field" v-model="staffNumber" @input="limitStaffNumber" placeholder="職員番号">
    </div>

    <div class="card">
        <h2>3. 組合員区分</h2>
        <div class="grid-2">
            <button @click="selectedMemberType = '組合員'" :class="['btn-option', { active: selectedMemberType === '組合員' }]">組合員</button>
            <button @click="selectedMemberType = '未組'" :class="['btn-option', { active: selectedMemberType === '未組' }]">未組</button>
        </div>
        <div v-if="selectedMemberType === '組合員'" style="margin-top:15px;">
            <input type="tel" class="input-field" v-model="memberNumber" @input="limitMemberNumber" placeholder="組合員番号（8桁）">
        </div>
    </div>

    <div class="card">
        <button class="btn-open-modal" :disabled="!isReadyToRecord || isUploading" @click="showModal = true">録音画面を開く</button>
        <div v-if="isUploading" class="loading-spinner">文字起こし中... しばらくお待ちください</div>
    </div>

    <div class="modal-overlay" v-if="showModal" @click.self="closeModal">
        <div class="modal-content">
            <button style="position:absolute; top:10px; right:15px; border:none; background:none; font-size:1.5rem;" @click="closeModal">×</button>
            <h3>{{ isRecording ? '録音中...' : 'ボタンを押して開始' }}</h3>
            
            <canvas id="visualizer"></canvas>

            <button class="btn-record" :class="{ recording: isRecording }" @click="toggleRecording">
                {{ isRecording ? '停止' : '録音開始' }}
            </button>
            <p style="font-size: 0.8rem; color: #666;">声に反応して波形が動きます</p>
        </div>
    </div>
</div>

<script>
new Vue({
    el: '#app',
    data: {
        staffNumber: '',
        stores: { 'ながお店': '151', '西くずは店': '152', '星ヶ丘店': '153', '枚方公園店': '154', '忍ケ丘店': '155', '粉浜店': '351', '東都島店': '451', '東中浜店': '452', 'つるみ店': '453' },
        selectedStore: '',
        categories: { '青果': '01', '鮮魚': '02', '精肉': '03', '惣菜': '04', 'グロサリー': '05', 'その他': '06' },
        selectedCategory: '',
        selectedMemberType: '',
        memberNumber: '',
        showModal: false,
        isRecording: false,
        isUploading: false,
        audioChunks: [],
        recorder: null,
        audioCtx: null,
        analyser: null,
        animationId: null,
        gasUrl: "https://script.google.com/macros/s/AKfycbxAxRr2pnLOlo2VdwpvOaw4SM7Yiod8wn1Yn8GyQTWiyJs1oUc6PAgNpN5dbt1cAqrdjQ/exec" 
    },
    computed: {
        isReadyToRecord() {
            const isStoreOk = this.selectedStore !== '';
            const isCategoryOk = this.selectedCategory !== '';
            const isStaffOk = this.staffNumber.length >= 1;
            let isMemberOk = (this.selectedMemberType === '未組') || (this.selectedMemberType === '組合員' && this.memberNumber.length === 8);
            return isStoreOk && isCategoryOk && isStaffOk && isMemberOk;
        }
    },
    mounted() {
        const savedStore = localStorage.getItem('selectedStore');
        if (savedStore && this.stores[savedStore]) this.selectedStore = savedStore;
        const savedCategory = localStorage.getItem('selectedCategory');
        if (savedCategory && this.categories[savedCategory]) this.selectedCategory = savedCategory;
    },
    methods: {
        limitStaffNumber() { this.staffNumber = this.staffNumber.replace(/\D/g, '').slice(0, 6); },
        limitMemberNumber() { this.memberNumber = this.memberNumber.replace(/\D/g, '').slice(0, 8); },
        saveStore() { localStorage.setItem('selectedStore', this.selectedStore); },
        saveCategory() { localStorage.setItem('selectedCategory', this.selectedCategory); },

        async toggleRecording() {
            if (!this.isRecording) {
                await this.startRecording();
            } else {
                this.stopRecording();
            }
        },

        async startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.isRecording = true;
                this.audioChunks = [];
                this.recorder = new MediaRecorder(stream);
                this.recorder.ondataavailable = e => this.audioChunks.push(e.data);
                this.recorder.start();

                // 波形ビジュアライザーのセットアップ
                this.setupVisualizer(stream);
            } catch (err) {
                alert("マイクの使用が許可されていないか、接続に問題があります。");
            }
        },

        setupVisualizer(stream) {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = this.audioCtx.createMediaStreamSource(stream);
            this.analyser = this.audioCtx.createAnalyser();
            this.analyser.fftSize = 256;
            source.connect(this.analyser);

            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');
            const bufferLength = this.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            const draw = () => {
                this.animationId = requestAnimationFrame(draw);
                this.analyser.getByteFrequencyData(dataArray);

                canvasCtx.fillStyle = '#f0f0f0';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 2;
                    canvasCtx.fillStyle = `rgb(229, 57, 53)`;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            };
            draw();
        },

        stopRecording() {
            if (!this.isRecording) return;
            this.isRecording = false;
            this.recorder.stop();
            
            // ビジュアライザー停止
            cancelAnimationFrame(this.animationId);
            if (this.audioCtx) this.audioCtx.close();

            this.recorder.onstop = async () => {
                this.showModal = false;
                await this.uploadToDrive();
            };
        },

        closeModal() {
            if (this.isRecording) {
                this.stopRecording();
            } else {
                this.showModal = false;
            }
        },

        async uploadToDrive() {
            this.isUploading = true;
            const now = new Date();
            
            // 1. 日時を 14桁 (YYYYMMDDHHMMSS) で生成
            const yyyy = now.getFullYear();
            const mm = ("0" + (now.getMonth() + 1)).slice(-2);
            const dd = ("0" + now.getDate()).slice(-2);
            const hh = ("0" + now.getHours()).slice(-2);
            const min = ("0" + now.getMinutes()).slice(-2);
            const sec = ("0" + now.getSeconds()).slice(-2);
            
            const timestamp = `${yyyy}${mm}${dd}${hh}${min}${sec}`; // 14桁

            // 2. 各コードの取得（既存のまま）
            const storeCode = this.stores[this.selectedStore]; // 3桁 
            const categoryCode = this.categories[this.selectedCategory]; // 2桁
            const paddedStaff = ("000000" + this.staffNumber).slice(-6); // 6桁
            const memberCode = this.selectedMemberType === '未組' ? '00000000' : this.memberNumber; // 8桁

            // 3. 全て連結して 33桁にする
            const fileName = `${timestamp}${storeCode}${categoryCode}${paddedStaff}${memberCode}.webm`; // 計33桁

            const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                const payload = {
                    fileName: fileName, // ここがGASの jsonData.fileName に対応
                    audioData: base64Data
                };

                try {
                    const response = await fetch(this.gasUrl, {
                        method: "POST",
                        mode: "no-cors", // 重要：CORSエラー回避
                        body: JSON.stringify(payload)
                    });
                    alert("送信しました。組声への反映には数秒かかります。");
                    location.reload();
                } catch (err) {
                    alert("送信エラー: ネット接続を確認してください。");
                } finally {
                    this.isUploading = false;
                }
            };
        }
    }
});
</script>
</body>
</html>



