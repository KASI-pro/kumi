<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接客報告システム</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .method-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: white; }
        button:disabled { background: #ccc; }
        .preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .preview-item { width: 80px; height: 80px; object-fit: cover; border: 1px solid #ddd; }
        textarea { width: 100%; height: 100px; margin-top: 10px; }
        .loading { color: #ff8c00; font-weight: bold; }
    </style>
</head>
<body>

<div id="app" class="card">
    <h2>接客内容報告</h2>

    <div class="method-selector">
        <button @click="mode = 'audio'" :style="mode === 'audio' ? 'background:#0056b3' : ''">音声</button>
        <button @click="mode = 'text'" :style="mode === 'text' ? 'background:#0056b3' : ''">文字入力</button>
        <button @click="openCamera" style="background: #28a745;">カメラ・画像選択</button>
    </div>

    <input type="file" ref="imageInput" accept="image/*" multiple style="display: none" @change="onImagesSelected">

    <div v-if="mode === 'text'">
        <textarea v-model="manualText" placeholder="接客内容を入力してください..."></textarea>
    </div>

    <div v-if="selectedImages.length > 0" style="margin-top: 15px;">
        <p>選択された画像: {{ selectedImages.length }}枚</p>
        <div class="preview-container">
            <img v-for="(src, index) in previewUrls" :key="index" :src="src" class="preview-item">
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button @click="submitAll" :disabled="isUploading" style="width: 100%; font-size: 1.2em; height: 50px;">
            報告を送信する
        </button>
    </div>

    <p v-if="isUploading" class="loading">{{ statusMessage }}</p>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/…Q/exec"; // あなたのGASのURLに差し替えてください

new Vue({
    el: '#app',
    data: {
        mode: 'audio',
        manualText: '',
        selectedImages: [],
        previewUrls: [],
        isUploading: false,
        statusMessage: ''
    },
    methods: {
        openCamera() {
            this.mode = 'image';
            this.$refs.imageInput.click();
        },
        onImagesSelected(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;

            this.selectedImages = files;
            this.previewUrls = [];
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.previewUrls.push(e.target.result);
                };
                reader.readAsDataURL(file);
            });
        },
        async submitAll() {
            this.isUploading = true;
            this.statusMessage = "送信中...";

            try {
                if (this.mode === 'image') {
                    // 【複数画像の一括処理】
                    // 共通のファイル名を生成（日時ベース）
                    const now = new Date();
                    const timestamp = now.getFullYear() + 
                        ("0" + (now.getMonth() + 1)).slice(-2) + 
                        ("0" + now.getDate()).slice(-2) + 
                        ("0" + now.getHours()).slice(-2) + 
                        ("0" + now.getMinutes()).slice(-2) + 
                        ("0" + now.getSeconds()).slice(-2);
                    
                    const commonFileName = "IMG_" + timestamp + ".jpg";

                    for (let i = 0; i < this.selectedImages.length; i++) {
                        this.statusMessage = `画像送信中... (${i + 1}/${this.selectedImages.length})`;
                        const base64 = await this.convertToBase64(this.selectedImages[i]);
                        
                        await this.postToGas({
                            mode: "image",
                            fileName: commonFileName, // 共通ファイル名
                            imageData: base64
                        });
                    }
                } else if (this.mode === 'text') {
                    // 文字入力モード
                    await this.postToGas({
                        mode: "text",
                        manualText: this.manualText,
                        fileName: "TEXT_REPORT.txt"
                    });
                } else {
                    // 音声モード（既存の録音処理が必要）
                    alert("音声モードの録音データがありません");
                }

                alert("送信が完了しました");
                this.resetForm();
            } catch (error) {
                console.error(error);
                alert("送信に失敗しました");
            } finally {
                this.isUploading = false;
                this.statusMessage = "";
            }
        },
        postToGas(payload) {
            return fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            }).then(res => res.json());
        },
        convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        },
        resetForm() {
            this.manualText = "";
            this.selectedImages = [];
            this.previewUrls = [];
            this.$refs.imageInput.value = "";
        }
    }
});
</script>

</body>
</html>
